---
- hosts: all
  vars:
    - homelab_password: '$6$7u1f9gq70zi0$Q8CkCjUlRIMqLZ3za.AHbudOm/j35tY/SGxYUOfJ2Ic.r0Rf3YRBD0igP.Vme6mQ0xuWUQoyJbL.mPb2iStrK0'
  gather_facts: no
  remote_user: pi
  tasks:
 
   - name: Add a new user named homelab
     user:
          name=homelab
          password={{ homelab_password }}
 
   - name: Add homelab user to the sudoers
     copy:
          dest: "/etc/sudoers.d/homelab"
          content: "provision  ALL=(ALL)  NOPASSWD: ALL"
 
   - name: Deploy SSH Key
     authorized_key: user=homelab
                     key="{{ lookup('file', '/home/homelab/.ssh/id_rsa.pub') }}"
                     state=present
 
   - name: Disable Password Authentication
     lineinfile:
           dest=/etc/ssh/sshd_config
           regexp='^PasswordAuthentication'
           line="PasswordAuthentication no"
           state=present
           backup=yes
     notify:
       - restart ssh
 
   - name: Disable Root Login
     lineinfile:
           dest=/etc/ssh/sshd_config
           regexp='^PermitRootLogin'
           line="PermitRootLogin no"
           state=present
           backup=yes
     notify:
       - restart ssh

  handlers:
   - name: restart ssh
     service:
       name=ssh
       state=restarted
