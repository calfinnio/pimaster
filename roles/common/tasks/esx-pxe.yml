---
- name: Create ESXi TFTP boot dir
  file:
    path: "{{ item.tftp_root }}esxi{{ item.major_version }}{{ item.minor_version }}"
    state: directory
  with_items: "{{ esxi_host }}"
  tags: [ 'esxi_build']

- name: Copy files from local to PXE/TFTP host
  copy:
    src: "{{ role_path }}/files/esxi/"
    dest: "{{ item.tftp_root }}esxi{{ item.major_version }}{{ item.minor_version }}"
    force: no
  with_items: "{{ esxi_host }}"
  when: refresh | default(False)
  tags: [ 'esxi_build']

- name: Using sed to remove "/" from boot.cfg
  shell:  sed -i 's/\///g' {{ item.tftp_root }}esxi{{ item.major_version }}{{ item.minor_version }}/boot.cfg
  with_items: "{{ esxi_host }}"
  tags: [ 'esxi_build']

- name: Creates directory
  file:
    path: /opt/www/html/ks
    state: directory
  tags: [ 'esxi_build']

- name: Create ks file for automated install
  template:
    src: ks.cfg.j2
    dest: /opt/www/html/ks/ks.cfg
  with_items: "{{ esxi_host }}"
  tags: [ 'esxi_build']

- name: replace line
  lineinfile: 
    dest: "{{ item.tftp_root }}esxi{{ item.major_version }}{{ item.minor_version }}/boot.cfg"
    regexp: '^(.*)kernelopt(.*)$' 
    line: 'kernelopt=ks=http://{{ ansible_default_ipv4 }}/ks/ks.cfg'
    backrefs: yes
  with_items: "{{ esxi_host }}"
  tags: [ 'esxi_build']
#- name: Write PXE config
